package io.github.apace100.origins.power;

import io.github.apace100.origins.registry.ModDamageSources;
import io.github.apace100.origins.registry.ModEnchantments;
import net.minecraft.enchantment.EnchantmentHelper;
import net.minecraft.entity.EquipmentSlot;
import net.minecraft.entity.player.PlayerEntity;
import net.minecraft.item.ItemStack;
import net.minecraft.world.Difficulty;

import java.util.Iterator;
import java.util.Map;

public class WaterVulnerabilityPower extends VariableIntPower {

    private final int damageTickInterval = 20;
    private final int beginDamageIn;
    private final float damageAmountEasy;
    private final float damageAmount;
    private final float waterProtectionEffectiveness;

    private int outOfWaterTicks;

    public WaterVulnerabilityPower(PowerType<?> type, PlayerEntity player, int beginDamageIn, int damageInterval, float damageAmountEasy, float damageAmount, float waterProtectionEffectiveness) {
        super(type, player, beginDamageIn, 0, Math.max(damageInterval, beginDamageIn));
        this.beginDamageIn = beginDamageIn;
        this.damageAmount = damageAmount;
        this.damageAmountEasy = damageAmountEasy;
        this.waterProtectionEffectiveness = waterProtectionEffectiveness;
    }

    @Override
    public int getMax() {
        int waterProt = getWaterProtection();
        if(waterProt >= 64) {
            return 20 * 60 * 20;
        }
        waterProt = (int)(waterProt * 2 * 20 * waterProtectionEffectiveness);
        return super.getMax() + waterProt;
    }

    public void inWater() {
        outOfWaterTicks = 0;
        if(getValue() <= 0) {
            setValue(damageTickInterval);
            player.damage(ModDamageSources.HURT_BY_WATER, player.world.getDifficulty() == Difficulty.EASY ? damageAmountEasy : damageAmount);
        } else {
            decrement();
        }
    }

    public void outOfWater() {
        if(outOfWaterTicks >= 20) {
            this.setValue(beginDamageIn);
        } else {
            outOfWaterTicks++;
        }
    }

    private int getWaterProtection() {
        Map<EquipmentSlot, ItemStack> enchantedItems = ModEnchantments.WATER_PROTECTION.getEquipment(player);
        Iterable<ItemStack> iterable = enchantedItems.values();
        if (iterable == null) {
            return 0;
        } else {
            int i = 0;
            Iterator var4 = iterable.iterator();

            while(var4.hasNext()) {
                ItemStack itemStack = (ItemStack)var4.next();
                i += EnchantmentHelper.getLevel(ModEnchantments.WATER_PROTECTION, itemStack);
            }

            return i * enchantedItems.size();
        }
    }
}
